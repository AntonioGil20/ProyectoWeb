<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vista de Mesas</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Estilos generales */
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f5f5f5;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Panel de mesas */
    .mesas-panel {
      flex: 1;
      background-color: white;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .mesas-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      padding: 10px;
    }

    .mesa-card {
      background-color: #4CAF50; /* Verde por defecto (Libre) */
      color: white;
      border-radius: 20px;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 120px;
    }

    .mesa-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .mesa-card.ocupada {
      background-color: #E53935; /* Rojo para ocupada */
    }

    .mesa-card.fuera-servicio {
      background-color: #FB8C00; /* Naranja para fuera de servicio */
    }

    .mesa-icon {
      font-size: 30px;
      margin-bottom: 10px;
    }

    .mesa-nombre {
      font-weight: bold;
      font-size: 18px;
    }

    .btn-llevar {
      position: fixed;
      bottom: 30px;
      left: 30px;
      background-color: white;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      cursor: pointer;
      z-index: 100;
    }

    .btn-llevar i {
      font-size: 30px;
      color: #333;
    }

    /* Panel de cuenta */
    .cuenta-panel {
      width: 450px;
      background-color: white;
      border-left: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .cuenta-header {
      background-color: #1976D2;
      color: white;
      padding: 15px;
      text-align: center;
      font-weight: bold;
      font-size: 18px;
    }

    .pedidos-container {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .pedido-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #eee;
    }

    .pedido-info {
      display: flex;
      align-items: center;
    }

    .pedido-cantidad {
      margin-right: 10px;
      font-weight: bold;
    }

    .pedido-nombre {
      flex: 1;
    }

    .pedido-precio {
      font-weight: bold;
      margin-right: 15px;
    }

    .btn-eliminar {
      background: none;
      border: none;
      color: #E53935;
      cursor: pointer;
      font-size: 16px;
      padding: 5px;
    }

    .total-container {
      padding: 15px;
      border-top: 1px solid #eee;
      background-color: #f9f9f9;
    }

    .total-line {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }

    .total-label {
      font-weight: bold;
    }

    .total-value {
      font-weight: bold;
    }

    .acciones-container {
      display: flex;
      padding: 15px;
      gap: 10px;
      border-top: 1px solid #eee;
      background-color: #f9f9f9;
    }

    .btn-accion {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }

    .btn-pagar {
      background-color: #4CAF50;
      color: white;
    }

    .btn-agregar {
      background-color: #2196F3;
      color: white;
      flex: 0 0 50px;
    }

    .btn-ticket {
      background-color: #333;
      color: white;
    }

    /* Modal para agregar pedido */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: white;
      border-radius: 10px;
      width: 80%;
      max-width: 600px;
      max-height: 80vh;
      overflow: auto;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .modal-header {
      padding: 15px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-weight: bold;
      font-size: 18px;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
    }

    .modal-body {
      padding: 15px;
    }

    .categorias-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .categoria-btn {
      padding: 12px;
      background-color: #2A3C7D;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      text-align: center;
      font-weight: bold;
    }

    /* Spinner */
    .spinner {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
    }

    .spinner i {
      font-size: 40px;
      color: #1976D2;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Panel de mesas -->
    <div class="mesas-panel">
      <div class="mesas-grid" id="mesas-grid">
        <!-- Mesas se cargarán aquí dinámicamente -->
      </div>
      <div class="btn-llevar" id="btn-llevar" title="Hacer pedido para llevar">
        <i class="fas fa-shopping-bag"></i>
      </div>
    </div>

    <!-- Panel de cuenta -->
    <div class="cuenta-panel">
      <div class="cuenta-header" id="nombre-mesa">Mesa no seleccionada</div>
      <div class="pedidos-container" id="pedidos-container">
        <!-- Pedidos se cargarán aquí dinámicamente -->
        <div class="empty-state">Seleccione una mesa para ver los pedidos</div>
      </div>
      <div class="total-container">
        <div class="total-line">
          <span class="total-label">Total MXN:</span>
          <span class="total-value" id="total-mxn">$0.00</span>
        </div>
        <div class="total-line">
          <span class="total-label">Total USD:</span>
          <span class="total-value" id="total-usd">$0.00</span>
        </div>
      </div>
      <div class="acciones-container">
        <button class="btn-accion btn-pagar" id="btn-pagar" disabled>
          <i class="fas fa-money-bill-wave"></i> Pagar
        </button>
        <button class="btn-accion btn-agregar" id="btn-agregar" disabled>
          <i class="fas fa-plus"></i>
        </button>
        <button class="btn-accion btn-ticket" id="btn-ticket" disabled>
          <i class="fas fa-file-invoice"></i> Ticket
        </button>
      </div>
    </div>
  </div>

  <!-- Modal para agregar pedido -->
  <div class="modal" id="modal-pedido">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Agregar pedido</div>
        <button class="modal-close" id="modal-close">&times;</button>
      </div>
      <div class="modal-body" id="modal-body">
        <!-- Contenido dinámico -->
      </div>
    </div>
  </div>

  <!-- Spinner -->
  <div class="spinner" id="spinner">
    <i class="fas fa-spinner fa-spin"></i>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script>
    // Aquí irá el código JavaScript para la funcionalidad
    document.addEventListener('DOMContentLoaded', function() {
      // Inicialización de Firebase
      const firebaseConfig = {
        apiKey: "TU_API_KEY",
        authDomain: "TU_AUTH_DOMAIN",
        databaseURL: "https://tacosypapasdb-default-rtdb.firebaseio.com",
        projectId: "TU_PROJECT_ID",
        storageBucket: "TU_STORAGE_BUCKET",
        messagingSenderId: "TU_SENDER_ID",
        appId: "TU_APP_ID"
      };
      
      // Inicializar Firebase
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();

      // Variables globales
      let mesaSeleccionada = null;
      let pedidos = [];
      
      // Elementos del DOM
      const mesasGrid = document.getElementById('mesas-grid');
      const pedidosContainer = document.getElementById('pedidos-container');
      const nombreMesaElement = document.getElementById('nombre-mesa');
      const totalMxnElement = document.getElementById('total-mxn');
      const totalUsdElement = document.getElementById('total-usd');
      const btnPagar = document.getElementById('btn-pagar');
      const btnAgregar = document.getElementById('btn-agregar');
      const btnTicket = document.getElementById('btn-ticket');
      const btnLlevar = document.getElementById('btn-llevar');
      const modalPedido = document.getElementById('modal-pedido');
      const modalBody = document.getElementById('modal-body');
      const modalClose = document.getElementById('modal-close');
      const spinner = document.getElementById('spinner');

      // Cargar mesas al iniciar
      cargarMesas();

      // Función para cargar las mesas desde Firebase
      async function cargarMesas() {
        showSpinner();
        try {
          const snapshot = await database.ref('Mesas').once('value');
          const mesas = snapshot.val();
          
          mesasGrid.innerHTML = '';
          
          if (mesas) {
            // Ordenar mesas por fila y columna
            const mesasOrdenadas = Object.values(mesas).sort((a, b) => {
              if (a.Fila !== b.Fila) return a.Fila - b.Fila;
              return a.Columna - b.Columna;
            });
            
            mesasOrdenadas.forEach(mesa => {
              const mesaCard = document.createElement('div');
              mesaCard.className = `mesa-card ${getEstadoClass(mesa.Estado)}`;
              mesaCard.innerHTML = `
                <div class="mesa-icon"><i class="fas fa-utensils"></i></div>
                <div class="mesa-nombre">${mesa.NombreMesa}</div>
              `;
              mesaCard.addEventListener('click', () => seleccionarMesa(mesa));
              mesasGrid.appendChild(mesaCard);
            });
          }
        } catch (error) {
          console.error('Error al cargar mesas:', error);
          alert('Error al cargar las mesas');
        } finally {
          hideSpinner();
        }
      }

      // Función para obtener la clase CSS según el estado
      function getEstadoClass(estado) {
        switch(estado) {
          case 'Ocupada': return 'ocupada';
          case 'Fuera de servicio': return 'fuera-servicio';
          default: return '';
        }
      }

      // Función para seleccionar una mesa
      async function seleccionarMesa(mesa) {
        showSpinner();
        mesaSeleccionada = mesa;
        nombreMesaElement.textContent = `Mesa: ${mesa.NombreMesa}`;
        
        // Resaltar mesa seleccionada
        document.querySelectorAll('.mesa-card').forEach(card => {
          card.classList.remove('selected');
        });
        event.currentTarget.classList.add('selected');
        
        // Cargar pedidos de la mesa
        await cargarPedidos(mesa.NombreMesa);
        
        // Habilitar botones
        btnPagar.disabled = false;
        btnAgregar.disabled = false;
        btnTicket.disabled = false;
        
        hideSpinner();
      }

      // Función para cargar los pedidos de una mesa
      async function cargarPedidos(nombreMesa) {
        try {
          const snapshot = await database.ref('Cuenta')
            .orderByChild('Mesa')
            .equalTo(nombreMesa)
            .once('value');
          
          pedidos = [];
          const pedidosData = snapshot.val();
          
          pedidosContainer.innerHTML = '';
          
          if (pedidosData) {
            Object.values(pedidosData).forEach(pedido => {
              pedidos.push(pedido);
              agregarPedidoALista(pedido);
            });
          } else {
            pedidosContainer.innerHTML = '<div class="empty-state">No hay pedidos para esta mesa</div>';
          }
          
          calcularTotales();
        } catch (error) {
          console.error('Error al cargar pedidos:', error);
          alert('Error al cargar los pedidos');
        }
      }

      // Función para agregar un pedido a la lista
      function agregarPedidoALista(pedido) {
        const pedidoItem = document.createElement('div');
        pedidoItem.className = 'pedido-item';
        pedidoItem.innerHTML = `
          <div class="pedido-info">
            <div class="pedido-cantidad">${pedido.Cantidad}</div>
            <div class="pedido-nombre">${pedido.Producto}</div>
          </div>
          <div class="pedido-precio">$${pedido.PrecioMx.toFixed(2)}</div>
          <button class="btn-eliminar" data-id="${pedido.Id}">
            <i class="fas fa-trash"></i>
          </button>
        `;
        pedidosContainer.appendChild(pedidoItem);
        
        // Agregar evento de eliminación
        pedidoItem.querySelector('.btn-eliminar').addEventListener('click', eliminarPedido);
      }

      // Función para eliminar un pedido
      async function eliminarPedido(event) {
        const idPedido = event.currentTarget.getAttribute('data-id');
        const confirmar = confirm('¿Estás seguro de eliminar este pedido?');
        
        if (confirmar) {
          showSpinner();
          try {
            await database.ref(`Cuenta/${idPedido}`).remove();
            
            // Actualizar lista local
            pedidos = pedidos.filter(p => p.Id !== idPedido);
            
            // Recargar vista
            await cargarPedidos(mesaSeleccionada.NombreMesa);
            
            // Verificar si no hay más pedidos para liberar la mesa
            if (pedidos.length === 0) {
              await actualizarEstadoMesa(mesaSeleccionada.NombreMesa, 'Libre');
              await cargarMesas();
            }
          } catch (error) {
            console.error('Error al eliminar pedido:', error);
            alert('Error al eliminar el pedido');
          } finally {
            hideSpinner();
          }
        }
      }

      // Función para calcular totales
      function calcularTotales() {
        const totalMxn = pedidos.reduce((sum, pedido) => sum + (pedido.PrecioMx * pedido.Cantidad), 0);
        const totalUsd = pedidos.reduce((sum, pedido) => sum + (pedido.PrecioUSD * pedido.Cantidad), 0);
        
        totalMxnElement.textContent = `$${totalMxn.toFixed(2)}`;
        totalUsdElement.textContent = `$${totalUsd.toFixed(2)}`;
      }

      // Función para actualizar estado de una mesa
      async function actualizarEstadoMesa(nombreMesa, nuevoEstado) {
        try {
          // Buscar la mesa en la base de datos
          const snapshot = await database.ref('Mesas')
            .orderByChild('NombreMesa')
            .equalTo(nombreMesa)
            .once('value');
          
          const mesas = snapshot.val();
          if (mesas) {
            const mesaKey = Object.keys(mesas)[0];
            await database.ref(`Mesas/${mesaKey}`).update({ Estado: nuevoEstado });
          }
        } catch (error) {
          console.error('Error al actualizar estado de mesa:', error);
          throw error;
        }
      }

      // Función para pagar la cuenta
      async function pagarCuenta() {
        if (!mesaSeleccionada || pedidos.length === 0) return;
        
        const confirmar = confirm(`¿Confirmar pago de la cuenta para ${mesaSeleccionada.NombreMesa}?`);
        
        if (confirmar) {
          showSpinner();
          try {
            // Preguntar si es pago con tarjeta
            const conTarjeta = confirm('¿El pago es con tarjeta?');
            
            // Aquí iría la lógica para aplicar descuento si es con tarjeta
            // y registrar la venta en el sistema
            
            // Eliminar todos los pedidos de la mesa
            const deletePromises = pedidos.map(pedido => 
              database.ref(`Cuenta/${pedido.Id}`).remove()
            );
            
            await Promise.all(deletePromises);
            
            // Actualizar estado de la mesa a Libre
            await actualizarEstadoMesa(mesaSeleccionada.NombreMesa, 'Libre');
            
            // Recargar vistas
            await cargarMesas();
            pedidosContainer.innerHTML = '<div class="empty-state">Cuenta pagada</div>';
            totalMxnElement.textContent = '$0.00';
            totalUsdElement.textContent = '$0.00';
            
            // Deshabilitar botones
            btnPagar.disabled = true;
            btnAgregar.disabled = true;
            btnTicket.disabled = true;
            
            // Generar ticket (aquí iría la lógica para generar el PDF)
            alert('Ticket generado (simulado)');
          } catch (error) {
            console.error('Error al pagar cuenta:', error);
            alert('Error al procesar el pago');
          } finally {
            hideSpinner();
          }
        }
      }

      // Función para mostrar modal de agregar pedido
      function mostrarModalAgregar() {
        modalBody.innerHTML = `
          <h3>Seleccione una categoría</h3>
          <div class="categorias-container">
            <button class="categoria-btn" data-categoria="Tacos">Tacos</button>
            <button class="categoria-btn" data-categoria="Quesadillas">Quesadillas</button>
            <button class="categoria-btn" data-categoria="Tostadas">Tostadas</button>
            <button class="categoria-btn" data-categoria="Bebidas con alcohol">Bebidas con alcohol</button>
            <button class="categoria-btn" data-categoria="Bebidas sin alcohol">Bebidas sin alcohol</button>
            <button class="categoria-btn" data-categoria="Postres">Postres</button>
          </div>
        `;
        
        // Agregar eventos a los botones de categoría
        document.querySelectorAll('.categoria-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const categoria = this.getAttribute('data-categoria');
            mostrarProductos(categoria);
          });
        });
        
        modalPedido.style.display = 'flex';
      }

      // Función para mostrar productos de una categoría
      function mostrarProductos(categoria) {
        // Aquí iría la lógica para cargar productos de la categoría desde Firebase
        // Por ahora simulamos con datos de ejemplo
        const productos = {
          'Tacos': ['Al pastor', 'Suadero', 'Longaniza', 'Tripa'],
          'Quesadillas': ['Queso', 'Huitlacoche', 'Flor de calabaza'],
          'Tostadas': ['Pata', 'Cuerito', 'Oreja'],
          'Bebidas con alcohol': ['Margarita', 'Michelada', 'Cerveza'],
          'Bebidas sin alcohol': ['Refresco', 'Agua', 'Jugo'],
          'Postres': ['Flan', 'Pastel', 'Helado']
        };
        
        modalBody.innerHTML = `
          <h3>${categoria}</h3>
          <div class="productos-container">
            ${productos[categoria].map(prod => `
              <div class="producto-item">
                <span>${prod}</span>
                <button class="btn-agregar-producto" data-producto="${prod}">Agregar</button>
              </div>
            `).join('')}
          </div>
          <button class="btn-volver" id="btn-volver">Volver</button>
        `;
        
        // Agregar evento al botón volver
        document.getElementById('btn-volver').addEventListener('click', mostrarModalAgregar);
        
        // Agregar eventos a los botones de producto
        document.querySelectorAll('.btn-agregar-producto').forEach(btn => {
          btn.addEventListener('click', function() {
            const producto = this.getAttribute('data-producto');
            agregarProducto(producto, categoria);
          });
        });
      }

      // Función para agregar un producto a la cuenta
      async function agregarProducto(nombreProducto, categoria) {
        showSpinner();
        try {
          // Aquí iría la lógica para obtener el precio del producto desde Firebase
          // Por ahora usamos precios simulados
          const precios = {
            'Tacos': { mxn: 15, usd: 0.75 },
            'Quesadillas': { mxn: 25, usd: 1.25 },
            'Tostadas': { mxn: 20, usd: 1.00 },
            'Bebidas con alcohol': { mxn: 50, usd: 2.50 },
            'Bebidas sin alcohol': { mxn: 20, usd: 1.00 },
            'Postres': { mxn: 30, usd: 1.50 }
          };
          
          const precio = precios[categoria] || { mxn: 0, usd: 0 };
          
          // Crear nuevo pedido
          const nuevoPedido = {
            Cantidad: 1,
            Producto: nombreProducto,
            PrecioMx: precio.mxn,
            PrecioUSD: precio.usd,
            Mesa: mesaSeleccionada.NombreMesa,
            Mesero: 'Administrador' // O el mesero actual
          };
          
          // Guardar en Firebase
          const newRef = database.ref('Cuenta').push();
          await newRef.set(nuevoPedido);
          
          // Actualizar estado de la mesa a Ocupada si no lo está
          if (mesaSeleccionada.Estado !== 'Ocupada') {
            await actualizarEstadoMesa(mesaSeleccionada.NombreMesa, 'Ocupada');
            await cargarMesas();
          }
          
          // Recargar pedidos
          await cargarPedidos(mesaSeleccionada.NombreMesa);
          
          // Cerrar modal
          modalPedido.style.display = 'none';
        } catch (error) {
          console.error('Error al agregar producto:', error);
          alert('Error al agregar el producto');
        } finally {
          hideSpinner();
        }
      }

      // Función para generar ticket
      async function generarTicket() {
        if (!mesaSeleccionada || pedidos.length === 0) return;
        
        showSpinner();
        try {
          // Aquí iría la lógica para generar el PDF
          // Por ahora simulamos con un alert
          alert(`Ticket generado para ${mesaSeleccionada.NombreMesa}\nTotal: ${totalMxnElement.textContent}`);
        } catch (error) {
          console.error('Error al generar ticket:', error);
          alert('Error al generar el ticket');
        } finally {
          hideSpinner();
        }
      }

      // Funciones para mostrar/ocultar spinner
      function showSpinner() {
        spinner.style.display = 'block';
      }

      function hideSpinner() {
        spinner.style.display = 'none';
      }

      // Event listeners
      btnPagar.addEventListener('click', pagarCuenta);
      btnAgregar.addEventListener('click', mostrarModalAgregar);
      btnTicket.addEventListener('click', generarTicket);
      btnLlevar.addEventListener('click', () => alert('Funcionalidad para llevar'));
      modalClose.addEventListener('click', () => modalPedido.style.display = 'none');
      
      // Cerrar modal al hacer clic fuera
      modalPedido.addEventListener('click', (e) => {
        if (e.target === modalPedido) {
          modalPedido.style.display = 'none';
        }
      });
    });
  </script>
</body>
</html>
